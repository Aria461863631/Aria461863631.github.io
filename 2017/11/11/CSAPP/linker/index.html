<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favico.jpg?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favico.jpg?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="CSAPP," />










<meta name="description" content="LinkerSUMMARY1.链接器的任务 7.6 Symbol Resolution - 符号解析 7.7 Relocation - 重定位  2.链接方式 7.2 ～ 7.9 Static lib - 静态链接 7.10 Shared lib - 链接时的共享库 7.11 Shared lib - 运行时的共享库  3.PIC 7.12 Position Independent Code -">
<meta name="keywords" content="CSAPP">
<meta property="og:type" content="article">
<meta property="og:title" content="[CS:APP-ch7] Linker">
<meta property="og:url" content="http://yoursite.com/2017/11/11/CSAPP/linker/index.html">
<meta property="og:site_name" content="Aria">
<meta property="og:description" content="LinkerSUMMARY1.链接器的任务 7.6 Symbol Resolution - 符号解析 7.7 Relocation - 重定位  2.链接方式 7.2 ～ 7.9 Static lib - 静态链接 7.10 Shared lib - 链接时的共享库 7.11 Shared lib - 运行时的共享库  3.PIC 7.12 Position Independent Code -">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://raw.githubusercontent.com/Aria461863631/MarkdownPic/master/Screenshot%20from%202017-10-16%2013-27-04.png">
<meta property="og:image" content="https://res.cloudinary.com/dsmx9qa2z/image/upload/v1539953133/Screenshot_from_2018-10-19_20-41-23.png">
<meta property="og:image" content="https://res.cloudinary.com/dsmx9qa2z/image/upload/v1539953133/Screenshot_from_2018-10-19_16-06-38.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Aria461863631/MarkdownPic/master/Screenshot%20from%202017-10-17%2021-57-55.png">
<meta property="og:image" content="https://res.cloudinary.com/dsmx9qa2z/image/upload/v1539953652/Screenshot_from_2018-10-19_20-53-40.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Aria461863631/MarkdownPic/master/Screenshot%20from%202017-10-17%2022-05-27.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Aria461863631/MarkdownPic/master/Screenshot%20from%202017-10-17%2022-24-45.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Aria461863631/MarkdownPic/master/Screenshot%20from%202017-10-17%2022-25-42.png">
<meta property="og:updated_time" content="2018-10-19T12:59:11.523Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[CS:APP-ch7] Linker">
<meta name="twitter:description" content="LinkerSUMMARY1.链接器的任务 7.6 Symbol Resolution - 符号解析 7.7 Relocation - 重定位  2.链接方式 7.2 ～ 7.9 Static lib - 静态链接 7.10 Shared lib - 链接时的共享库 7.11 Shared lib - 运行时的共享库  3.PIC 7.12 Position Independent Code -">
<meta name="twitter:image" content="https://raw.githubusercontent.com/Aria461863631/MarkdownPic/master/Screenshot%20from%202017-10-16%2013-27-04.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/11/11/CSAPP/linker/"/>





  <title>[CS:APP-ch7] Linker | Aria</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4c0218a0351c2e89b660f64b588ff880";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>





  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.12.0/styles/atom-one-dark.min.css" ><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Aria</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">あなたには僕が見えるが?</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/11/CSAPP/linker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Aria">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Aria">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">[CS:APP-ch7] Linker</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-11T15:30:00+08:00">
                2017-11-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-System-a-Programmer-s-Perspective/" itemprop="url" rel="index">
                    <span itemprop="name">Computer System a Programmer's Perspective</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/11/11/CSAPP/linker/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2017/11/11/CSAPP/linker/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Linker"><a href="#Linker" class="headerlink" title="Linker"></a>Linker</h1><h3 id="SUMMARY"><a href="#SUMMARY" class="headerlink" title="SUMMARY"></a>SUMMARY</h3><h4 id="1-链接器的任务"><a href="#1-链接器的任务" class="headerlink" title="1.链接器的任务"></a>1.链接器的任务</h4><ul>
<li><a href="#7.6">7.6 Symbol Resolution - 符号解析</a></li>
<li><a href="#7.7">7.7 Relocation - 重定位</a></li>
</ul>
<h4 id="2-链接方式"><a href="#2-链接方式" class="headerlink" title="2.链接方式"></a>2.链接方式</h4><ul>
<li><a href="#7.6.2">7.2 ～ 7.9 Static lib - 静态链接</a></li>
<li><a href="#7.10">7.10 Shared lib - 链接时的共享库</a></li>
<li><a href="#7.11">7.11 Shared lib - 运行时的共享库</a></li>
</ul>
<h4 id="3-PIC"><a href="#3-PIC" class="headerlink" title="3.PIC"></a>3.PIC</h4><ul>
<li><a href="#7.12">7.12 Position Independent Code - 位置无关</a></li>
</ul>
<a id="more"></a>
<p><br> </p>
<hr>
<h3 id="7-1-Complier-Driver-编译器驱动"><a href="#7-1-Complier-Driver-编译器驱动" class="headerlink" title="7.1 Complier Driver - 编译器驱动"></a>7.1 Complier Driver - 编译器驱动</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
</pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">referenced_sum</span> <span class="params">( <span class="keyword">int</span> *a, <span class="keyword">int</span> n )</span></span>;</span>
<span class="line"></span>
<span class="line"><span class="function"><span class="keyword">void</span> <span class="title">defined_fun</span> <span class="params">()</span> </span>&#123;&#125;</span>
<span class="line"></span>
<span class="line"><span class="keyword">int</span> <span class="built_in">array</span>[ <span class="number">2</span> ] = &#123;<span class="number">1</span>, <span class="number">2</span>&#125;;</span>
<span class="line"></span>
<span class="line"><span class="keyword">int</span> zero_global = <span class="number">0</span>;</span>
<span class="line"><span class="keyword">static</span> <span class="keyword">int</span> zero_static = <span class="number">0</span>;</span>
<span class="line"></span>
<span class="line"><span class="keyword">static</span> <span class="keyword">int</span> ini_static = <span class="number">7</span>;</span>
<span class="line"><span class="keyword">int</span> ini_global = <span class="number">8</span>;</span>
<span class="line"></span>
<span class="line"><span class="keyword">int</span> uninitialize_global;</span>
<span class="line"><span class="keyword">static</span> <span class="keyword">int</span> uninitialize_static;</span>
<span class="line"></span>
<span class="line"><span class="keyword">const</span> <span class="keyword">char</span> const_string[ <span class="number">6</span> ] = <span class="string">"Hello"</span>;</span>
<span class="line"></span>
<span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span>
<span class="line">        defined_fun ();</span>
<span class="line">        <span class="keyword">int</span> local_val = referenced_sum ( <span class="built_in">array</span>, <span class="number">2</span> );</span>
<span class="line">        <span class="built_in">printf</span> ( <span class="string">"%s\n"</span>, const_string );</span>
<span class="line">        <span class="keyword">return</span> local_val;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p><strong>1.预处理器(cpp)</strong></p>
<ul>
<li>将源程序翻译成一个ASCII码的中间文件 main.i</li>
</ul>
<p><strong>2.C编译器(cc1)</strong></p>
<ul>
<li>将main.i翻译成一个ASCII汇编语言文件 main.s</li>
</ul>
<p><strong>3.汇编器(as)</strong></p>
<ul>
<li>将main.s翻译成一个可重定位目标文件 main.o</li>
</ul>
<p><strong>4.链接器(ld)</strong></p>
<ul>
<li>将多个.o文件以及一些必要的系统目标文件组合起来，创建一个可执行目标文件</li>
</ul>
<p>(ps……..链接出来的程序并不能正常运行）<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
</pre></td><td class="code"><pre><span class="line">ld: warning: cannot find entry symbol _start; defaulting to <span class="number">00000000004000e8</span></span>
</pre></td></tr></table></figure></p>
<p><img src="https://raw.githubusercontent.com/Aria461863631/MarkdownPic/master/Screenshot%20from%202017-10-16%2013-27-04.png" alt="Compiler Driver"></p>
<p><br></p>
<p><span id="7.6.2"></span></p>
<hr>
<h3 id="7-2-Static-Library-静态链接"><a href="#7-2-Static-Library-静态链接" class="headerlink" title="7.2 Static Library - 静态链接"></a>7.2 Static Library - 静态链接</h3><p><strong>为什么</strong>要使用链接器?</p>
<p><strong>1.模块化角度考虑</strong></p>
<ul>
<li>我们可以把程序分散到不同的小的源代码中，而不是一个巨大的类中。这样带来的好处是可以复用常见的功能/库，比方说 Math library, standard C library.</li>
</ul>
<p><strong>2.效率角度考虑</strong></p>
<ul>
<li>改动代码时只需要重新编译改动的文件，其他不受影响。而常用的函数和功能可以封装成库，提供给程序进行调用（节省空间）</li>
</ul>
<p>链接器的<strong>任务</strong>主要有两个</p>
<p><strong>1.Symbol Resolution 符号解析</strong></p>
<ul>
<li>将每个符号的引用和唯一的定义相关联 （符号包括变量名和函数名）</li>
</ul>
<p><strong>2.Relocation 重定位</strong></p>
<ul>
<li>将每个符号的定义和一个内存地址相关联 </li>
</ul>
<p><br></p>
<hr>
<h3 id="7-3-Object-Files-目标文件"><a href="#7-3-Object-Files-目标文件" class="headerlink" title="7.3 Object Files - 目标文件"></a>7.3 Object Files - 目标文件</h3><p>3种目标文件</p>
<ul>
<li>Relocatable 可重定位</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">//gcc -c main.c</span></span>
<span class="line">  Type:                              REL (Relocatable file)</span>
</pre></td></tr></table></figure>
<ul>
<li>Executable 可执行</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">//ld -o prog main.o sum.o </span></span>
<span class="line">  Type:                              EXEC (Executable file)</span>
</pre></td></tr></table></figure>
<ul>
<li>Shared 可共享</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">//gcc main.c 默认</span></span>
<span class="line">  Type:                              DYN (Shared object file)</span>
</pre></td></tr></table></figure>
<p>目标文件的格式：这里主要讨论ELF格式<br><br></p>
<hr>
<h3 id="7-4-Relocatable-Object-Files-可重定位"><a href="#7-4-Relocatable-Object-Files-可重定位" class="headerlink" title="7.4 Relocatable Object Files - 可重定位"></a>7.4 Relocatable Object Files - 可重定位</h3><p>格式：<br>| 组成        | 解释   |<br>| ——–   | —– |<br>| ELF header | 生成此文件的系统等|<br>|.text|已编译程序的机器码|<br>|.radata|只读数据|<br>|.data|已初始化的全局/静态变量|<br>|.bss|未初始化的静态，初始化为0的全局/静态 |<br>||(未初始化全局是COM） |<br>|.symtab|所有 定义或引用 的 函数 和 全局变量|<br>|.rel.text|要重定位的函数在.text的位置|<br>|.rel.data|全局变量的重定位信息|<br>|.debug|<br>|.line|<br>|.strtab|<br>|Section header table|记录每个section的位置和大小|</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
</pre></td><td class="code"><pre><span class="line">ELF Header:</span>
<span class="line">  Magic:   <span class="number">7f</span> <span class="number">45</span> <span class="number">4</span>c <span class="number">46</span> <span class="number">02</span> <span class="number">01</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> </span>
<span class="line">  Class:                             ELF64</span>
<span class="line">  Data:                              <span class="number">2'</span>s complement, little endian</span>
<span class="line">  Version:                           <span class="number">1</span> (current)</span>
<span class="line">  OS/ABI:                            UNIX - System V</span>
<span class="line">  ABI Version:                       <span class="number">0</span></span>
<span class="line">  Type:                              REL (Relocatable file)</span>
<span class="line">  Machine:                           Advanced Micro Devices X86<span class="number">-64</span></span>
<span class="line">  Version:                           <span class="number">0x1</span></span>
<span class="line">  Entry point address:               <span class="number">0x0</span></span>
<span class="line">  Start of program headers:          <span class="number">0</span> (bytes into file)</span>
<span class="line">  Start of section headers:          <span class="number">1144</span> (bytes into file)</span>
<span class="line">  Flags:                             <span class="number">0x0</span></span>
<span class="line">  Size of <span class="keyword">this</span> header:               <span class="number">64</span> (bytes)</span>
<span class="line">  Size of program headers:           <span class="number">0</span> (bytes)</span>
<span class="line">  Number of program headers:         <span class="number">0</span></span>
<span class="line">  Size of section headers:           <span class="number">64</span> (bytes)</span>
<span class="line">  Number of section headers:         <span class="number">13</span></span>
<span class="line">  Section header <span class="built_in">string</span> table index: <span class="number">12</span></span>
</pre></td></tr></table></figure>
<p><br></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
</pre></td><td class="code"><pre><span class="line">Section Headers:</span>
<span class="line"> Section Headers:</span>
<span class="line">  [Nr] Name              Type             Address           Offset</span>
<span class="line">       Size              EntSize          Flags  Link  Info  Align</span>
<span class="line">  [ <span class="number">0</span>]                   <span class="literal">NULL</span>             <span class="number">0000000000000000</span>  <span class="number">00000000</span></span>
<span class="line">       <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>           <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span>
<span class="line">  [ <span class="number">1</span>] .text             PROGBITS         <span class="number">0000000000000000</span>  <span class="number">00000040</span></span>
<span class="line">       <span class="number">0000000000000032</span>  <span class="number">0000000000000000</span>  AX       <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span>
<span class="line">  [ <span class="number">2</span>] .rela.text        RELA             <span class="number">0000000000000000</span>  <span class="number">00000398</span></span>
<span class="line">       <span class="number">0000000000000048</span>  <span class="number">0000000000000018</span>   I      <span class="number">10</span>     <span class="number">1</span>     <span class="number">8</span></span>
<span class="line">  [ <span class="number">3</span>] .data             PROGBITS         <span class="number">0000000000000000</span>  <span class="number">00000078</span></span>
<span class="line">       <span class="number">0000000000000010</span>  <span class="number">0000000000000000</span>  WA       <span class="number">0</span>     <span class="number">0</span>     <span class="number">8</span></span>
<span class="line">  [ <span class="number">4</span>] .bss              NOBITS           <span class="number">0000000000000000</span>  <span class="number">00000088</span></span>
<span class="line">       <span class="number">000000000000000</span>c  <span class="number">0000000000000000</span>  WA       <span class="number">0</span>     <span class="number">0</span>     <span class="number">4</span></span>
<span class="line">  [ <span class="number">5</span>] .rodata           PROGBITS         <span class="number">0000000000000000</span>  <span class="number">00000088</span></span>
<span class="line">       <span class="number">0000000000000006</span>  <span class="number">0000000000000000</span>   A       <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span>
<span class="line">  [ <span class="number">6</span>] .comment          PROGBITS         <span class="number">0000000000000000</span>  <span class="number">0000008</span>e</span>
<span class="line">       <span class="number">0000000000000012</span>  <span class="number">0000000000000001</span>  MS       <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span>
<span class="line">  [ <span class="number">7</span>] .note.GNU-<span class="built_in">stack</span>   PROGBITS         <span class="number">0000000000000000</span>  <span class="number">000000</span>a0</span>
<span class="line">       <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>           <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span>
<span class="line">  [ <span class="number">8</span>] .eh_frame         PROGBITS         <span class="number">0000000000000000</span>  <span class="number">000000</span>a0</span>
<span class="line">       <span class="number">0000000000000058</span>  <span class="number">0000000000000000</span>   A       <span class="number">0</span>     <span class="number">0</span>     <span class="number">8</span></span>
<span class="line">  [ <span class="number">9</span>] .rela.eh_frame    RELA             <span class="number">0000000000000000</span>  <span class="number">000003e0</span></span>
<span class="line">       <span class="number">0000000000000030</span>  <span class="number">0000000000000018</span>   I      <span class="number">10</span>     <span class="number">8</span>     <span class="number">8</span></span>
<span class="line">  [<span class="number">10</span>] .symtab           SYMTAB           <span class="number">0000000000000000</span>  <span class="number">000000f</span>8</span>
<span class="line">       <span class="number">00000000000001f</span>8  <span class="number">0000000000000018</span>          <span class="number">11</span>    <span class="number">12</span>     <span class="number">8</span></span>
<span class="line">  [<span class="number">11</span>] .strtab           STRTAB           <span class="number">0000000000000000</span>  <span class="number">000002f</span>0</span>
<span class="line">       <span class="number">00000000000000</span>a7  <span class="number">0000000000000000</span>           <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span>
<span class="line">  [<span class="number">12</span>] .shstrtab         STRTAB           <span class="number">0000000000000000</span>  <span class="number">00000410</span></span>
<span class="line">       <span class="number">0000000000000061</span>  <span class="number">0000000000000000</span>           <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span>
</pre></td></tr></table></figure>
<p><br></p>
<hr>
<h3 id="7-5-Symbol-and-Symbol-Tables-符号和符号表"><a href="#7-5-Symbol-and-Symbol-Tables-符号和符号表" class="headerlink" title="7.5 Symbol and Symbol Tables - 符号和符号表"></a>7.5 Symbol and Symbol Tables - 符号和符号表</h3><p>每一个symbol都代表一个 函数 / 全局变量 / 静态变量</p>
<h4 id="symbol的种类有3个"><a href="#symbol的种类有3个" class="headerlink" title="symbol的种类有3个"></a>symbol的种类有3个</h4><p><strong>1.Global</strong></p>
<ul>
<li>本模块定义的符号。包括非静态的函数和全局变量</li>
</ul>
<p><strong>2.Global（Extern）</strong></p>
<ul>
<li>其他模块定义，本模块引用的符号。包括其他文件里的非静态的函数和全局变量</li>
</ul>
<p><strong>3.Local</strong></p>
<ul>
<li>本模块定义且只能被本模块引用的。包括静态属性的函数和全局变量。</li>
</ul>
<p>其他</p>
<ul>
<li>1.普通的局部变量在运行时由栈管理</li>
<li>2.静态属性的局部变量在.data/.bss中，且拥有唯一的名字<br>如书上的例子：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
</pre></td><td class="code"><pre><span class="line"><span class="number">5</span>: <span class="number">0000000000000000</span> <span class="number">4</span> OBJECT  LOCAL  DEFAULT    <span class="number">4</span> x<span class="number">.1794</span></span>
<span class="line"><span class="number">6</span>: <span class="number">0000000000000000</span> <span class="number">4</span> OBJECT  LOCAL  DEFAULT    <span class="number">3</span> x<span class="number">.1797</span></span>
</pre></td></tr></table></figure>
<h4 id="每个symbol的结构"><a href="#每个symbol的结构" class="headerlink" title="每个symbol的结构"></a>每个symbol的结构</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span>
<span class="line">        <span class="keyword">int</span> name;            <span class="comment">//在strtab里的偏移量</span></span>
<span class="line">        <span class="keyword">char</span> type : <span class="number">4</span>,       <span class="comment">//是函数还是数据   </span></span>
<span class="line">             binding : <span class="number">4</span>;    <span class="comment">//全局还是局部</span></span>
<span class="line">        <span class="keyword">char</span> reserved;          </span>
<span class="line">        <span class="keyword">short</span> section;       <span class="comment">//所在节的索引，三个伪节ABS,UNDEF,COM   （下面的Ndx）</span></span>
<span class="line">        <span class="keyword">long</span> value;          <span class="comment">//对Reloctable OBJ File:所在节到symbol的偏移（相对地址），Executable: 会变成绝对地址（见7.7）</span></span>
<span class="line">        <span class="keyword">long</span> size;            <span class="comment">//目标（符号）的大小（字节为单位）  </span></span>
<span class="line">&#125; ELf64_Symbol;</span>
</pre></td></tr></table></figure>
<p>ABS: 不应被重定位的symbol<br>UNDEF: 未定义的<br>COMMON: 未初始化的全局</p>
<p><br></p>
<p>Num：.symtab表的标号，符号的个数。<br>一个SymbolTable的例子：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
</pre></td><td class="code"><pre><span class="line">Symbol table '.symtab' contains 22 entries:</span>
<span class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span>
<span class="line">     <span class="number">0</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT  UND </span>
<span class="line">     <span class="number">1</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FILE    LOCAL  DEFAULT  ABS main.c</span>
<span class="line">     <span class="number">2</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">1</span> </span>
<span class="line">     <span class="number">3</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">3</span> </span>
<span class="line">     <span class="number">4</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">4</span> </span>
<span class="line">     <span class="number">5</span>: <span class="number">0000000000000004</span>     <span class="number">4</span> OBJECT  LOCAL  DEFAULT    <span class="number">4</span> zero_static</span>
<span class="line">     <span class="number">6</span>: <span class="number">0000000000000008</span>     <span class="number">4</span> OBJECT  LOCAL  DEFAULT    <span class="number">3</span> ini_static</span>
<span class="line">     <span class="number">7</span>: <span class="number">0000000000000008</span>     <span class="number">4</span> OBJECT  LOCAL  DEFAULT    <span class="number">4</span> uninitialize_static</span>
<span class="line">     <span class="number">8</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">5</span> </span>
<span class="line">     <span class="number">9</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">7</span> </span>
<span class="line">    <span class="number">10</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">8</span> </span>
<span class="line">    <span class="number">11</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">6</span> </span>
<span class="line">    <span class="number">12</span>: <span class="number">0000000000000000</span>     <span class="number">7</span> FUNC    GLOBAL DEFAULT    <span class="number">1</span> defined_fun</span>
<span class="line">    <span class="number">13</span>: <span class="number">0000000000000000</span>     <span class="number">8</span> OBJECT  GLOBAL DEFAULT    <span class="number">3</span> <span class="built_in">array</span></span>
<span class="line">    <span class="number">14</span>: <span class="number">0000000000000000</span>     <span class="number">4</span> OBJECT  GLOBAL DEFAULT    <span class="number">4</span> zero_global</span>
<span class="line">    <span class="number">15</span>: <span class="number">000000000000000</span>c     <span class="number">4</span> OBJECT  GLOBAL DEFAULT    <span class="number">3</span> ini_global</span>
<span class="line">    <span class="number">16</span>: <span class="number">0000000000000004</span>     <span class="number">4</span> OBJECT  GLOBAL DEFAULT  COM uninitialize_global</span>
<span class="line">    <span class="number">17</span>: <span class="number">0000000000000000</span>     <span class="number">6</span> OBJECT  GLOBAL DEFAULT    <span class="number">5</span> const_string</span>
<span class="line">    <span class="number">18</span>: <span class="number">0000000000000007</span>    <span class="number">55</span> FUNC    GLOBAL DEFAULT    <span class="number">1</span> main</span>
<span class="line">    <span class="number">19</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND _GLOBAL_OFFSET_TABLE_</span>
<span class="line">    <span class="number">20</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND referenced_sum</span>
<span class="line">    <span class="number">21</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND <span class="built_in">puts</span></span>
</pre></td></tr></table></figure></p>
<p>rt<br><code>.text</code> 里有 <code>defined_fun</code>,<code>main</code><br><code>.data</code> 里有 <code>array</code>, <code>ini_static</code>, <code>ini_global</code><br><code>.bss</code> 里有 <code>uninitialize_static</code>, <code>zero_static</code>, <code>zero_global</code><br><code>.rodata</code> 里有 <code>const_string</code><br><code>COM</code> 有 <code>uninitialize_global</code><br><code>UNDF</code> 有 <code>referenced_sum</code> , <code>puts</code> , <code>GOT表</code></p>
<p>Type:<br><code>ini_static</code> , <code>uninitialize_static</code> , <code>zero_static</code> 都是 <strong>Local</strong><br>其他都是 <strong>Global</strong></p>
<p><br></p>
<p><span id="7.6"></span></p>
<hr>
<h3 id="7-6-Symbol-Resolution-符号解析"><a href="#7-6-Symbol-Resolution-符号解析" class="headerlink" title="7.6 Symbol Resolution - 符号解析"></a>7.6 Symbol Resolution - 符号解析</h3><p><strong>让所有的引用和符号表中唯一的符号定义相关联</strong></p>
<ol>
<li><p>Local Symbol: 给予唯一名字和定义</p>
</li>
<li><p>Global Symbol: 非本模块定义，留给链接器处理</p>
</li>
</ol>
<p><br></p>
<h4 id="7-6-1-Resolve-Multiply-Defined-Global-Symbols"><a href="#7-6-1-Resolve-Multiply-Defined-Global-Symbols" class="headerlink" title="7.6.1 Resolve Multiply Defined Global Symbols"></a>7.6.1 Resolve Multiply Defined Global Symbols</h4><p>定义符号的强/弱</p>
<p><strong>强</strong></p>
<ul>
<li>函数/已初始化的变量</li>
</ul>
<p><strong>弱</strong></p>
<ul>
<li>未初始化的变量</li>
</ul>
<p><strong>规则</strong></p>
<ol>
<li>不能有多个同名的强符号</li>
<li>同名的强符号和弱符号，选择强的符号</li>
<li>多个同名的弱符号任意选一个</li>
</ol>
<p>遇到多重定义的符号时警告<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span>
</pre></td><td class="code"><pre><span class="line">gcc -fno-common main.c func.c -o t</span>
</pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="7-6-2-Linking-with-Static-Libraries-链接静态库"><a href="#7-6-2-Linking-with-Static-Libraries-链接静态库" class="headerlink" title="7.6.2 Linking with Static Libraries - 链接静态库"></a>7.6.2 Linking with Static Libraries - 链接静态库</h4><p>静态库在程序链接的时候使用<br>链接器会将程序中使用到函数的代码从库文件中拷贝到应用程序中。</p>
<p>静态库包含多个可重定位目标文件和描述各成员的头部，以archive存档的形式保存</p>
<p><strong>优点</strong></p>
<ul>
<li>编译后的执行程序不需要外部的函数库支持</li>
</ul>
<p><strong>缺点</strong></p>
<ol>
<li>体积较大</li>
<li>静态函数库改变了，那么程序必须重新链接</li>
<li>多个可执行文件链接在一个库上时，运行会使库里的代码重复复制到内存，造成浪费</li>
</ol>
<p>建立,链接方法<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
</pre></td><td class="code"><pre><span class="line">ar rcs libvector.a addvec.o multvec.o</span>
<span class="line">gcc -static -o prog2C main2.o ./libvector.a</span>
</pre></td></tr></table></figure></p>
<p>此外，链接的时候，拷贝到最终可执行文件的基本单位还是模块<br>比如只用到了addvec.o，就不会同时打包libvector.a里面的multvec.o</p>
<p><br></p>
<h4 id="7-6-3-Use-static-library-resolve-reference"><a href="#7-6-3-Use-static-library-resolve-reference" class="headerlink" title="7.6.3 Use static library resolve reference"></a>7.6.3 Use static library resolve reference</h4><p><strong>集合E</strong></p>
<ul>
<li>所有重定位的目标文件</li>
</ul>
<p><strong>集合U</strong></p>
<ul>
<li>未解析的符号引用</li>
</ul>
<p><strong>集合D</strong></p>
<ul>
<li>已经定义的符号</li>
</ul>
<p><img src="https://res.cloudinary.com/dsmx9qa2z/image/upload/v1539953133/Screenshot_from_2018-10-19_20-41-23.png" alt=""></p>
<p>最后U为空，则成功</p>
<p>按顺序扫描，所以，一般将库放在命令行的结尾。<br>若是有特殊的需求，比如循环引用，也可以在命令行上重复导入某个库。<br>（出现这种情况，更好的办法应该是，这两个相互依赖的模块放在同一个.a存档文件中）。<br><br></p>
<p><span id="7.7"></span></p>
<hr>
<h3 id="7-7-Relocation-重定位"><a href="#7-7-Relocation-重定位" class="headerlink" title="7.7 Relocation - 重定位"></a>7.7 Relocation - 重定位</h3><p><strong>合并输入模块，为每个符号分配运行时地址</strong></p>
<p>步骤<br><strong>1.重定位（section）节和（symbol）符号定义</strong></p>
<ul>
<li>合并各文件里同名的节，运行地址赋给每个指令<br>这一步完成时，程序中的每一个指令和全局变量都有唯一的运行时存储器地址了。</li>
</ul>
<p><strong>2.重定位符号引用</strong></p>
<ul>
<li>链接器修改引用指向运行时地址，依靠relocation entry（重定位条目）<br><br></li>
</ul>
<p>重定位节（section）<br>可以看到Relocate里的ADDR是0<br>但Exec里的ADDR是4000e8<br>(动态链接又是相对的了，7.9）<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
</pre></td><td class="code"><pre><span class="line">Section Headers:</span>
<span class="line">  [Nr] Name              Type             Address           Offset</span>
<span class="line">       Size              EntSize          Flags  Link  Info  Align</span>
<span class="line"># Relocate：</span>
<span class="line">[ <span class="number">1</span>] .text             PROGBITS         <span class="number">0000000000000000</span>  <span class="number">00000040</span></span>
<span class="line">       <span class="number">000000000000003</span>e  <span class="number">0000000000000000</span>  AX       <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span>
<span class="line"># Executable:</span>
<span class="line">[ <span class="number">1</span>] .text             PROGBITS         <span class="number">00000000004000e8</span>  <span class="number">000000e8</span></span>
<span class="line">       <span class="number">0000000000000061</span>  <span class="number">0000000000000000</span>  AX       <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span>
<span class="line"># Dynamic:</span>
<span class="line">[<span class="number">11</span>] .text             PROGBITS         <span class="number">00000000000004f</span>0  <span class="number">000004f</span>0</span>
<span class="line">       <span class="number">0000000000000202</span>  <span class="number">0000000000000000</span>  AX       <span class="number">0</span>     <span class="number">0</span>     <span class="number">16</span></span>
</pre></td></tr></table></figure></p>
<p>重定位符号（Symbol）<br>Value不同</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
</pre></td><td class="code"><pre><span class="line">Symbol Table '.symtab'</span>
<span class="line">Num:    Value          Size Type    Bind   Vis      Ndx Name</span>
<span class="line"># Relocate:</span>
<span class="line">      <span class="number">15</span>: <span class="number">000000000000000</span>c     <span class="number">4</span> OBJECT  GLOBAL DEFAULT    <span class="number">3</span> ini_global</span>
<span class="line"># Executable:</span>
<span class="line">      <span class="number">12</span>: <span class="number">0000000000601018</span>     <span class="number">4</span> OBJECT  GLOBAL DEFAULT    <span class="number">5</span> ini_global</span>
<span class="line"># Dynamic:</span>
<span class="line">      <span class="number">50</span>: <span class="number">0000000000201034</span>     <span class="number">4</span> OBJECT  GLOBAL DEFAULT   <span class="number">21</span> ini_global</span>
</pre></td></tr></table></figure>
<p><br></p>
<h4 id="7-7-1-Relocation-Entry-重定位条目"><a href="#7-7-1-Relocation-Entry-重定位条目" class="headerlink" title="7.7.1 Relocation Entry - 重定位条目"></a>7.7.1 Relocation Entry - 重定位条目</h4><p>汇编器遇到未知的引用生成重定位条目<br>函数放到.rel.text<br>未初始化数据放到.rel.data</p>
<p>每个条目的格式<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
</pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span>&#123;</span></span>
<span class="line">    <span class="keyword">long</span> offset;          <span class="comment">//在所在节的偏移量</span></span>
<span class="line">    <span class="keyword">long</span> type: <span class="number">32</span>,            </span>
<span class="line">         symbol: <span class="number">32</span>;      <span class="comment">//引用指向的symbol</span></span>
<span class="line">    <span class="keyword">long</span> addend;          </span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure></p>
<p>两种类型：<br>1.R_X86_64_PC32 相对寻址<br>2.R_X86_64_32   直接寻址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
</pre></td><td class="code"><pre><span class="line">Relocation section '.rela.text' at offset 0x398 contains 3 entries:</span>
<span class="line">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span>
<span class="line"><span class="number">000000000015</span>  <span class="number">000</span>c00000002 R_X86_64_PC32     <span class="number">0000000000000000</span> defined_fun - <span class="number">4</span></span>
<span class="line"><span class="number">000000000021</span>  <span class="number">000</span>d00000002 R_X86_64_PC32     <span class="number">0000000000000000</span> <span class="built_in">array</span> - <span class="number">4</span></span>
<span class="line"><span class="number">000000000026</span>  <span class="number">001400000004</span> R_X86_64_PLT32    <span class="number">0000000000000000</span> referenced_sum - <span class="number">4</span></span>
</pre></td></tr></table></figure>
<p><br></p>
<h4 id="7-7-2-Relocating-Symbol-References"><a href="#7-7-2-Relocating-Symbol-References" class="headerlink" title="7.7.2 Relocating Symbol References"></a>7.7.2 Relocating Symbol References</h4><p>还是书上的例子比较详细…….<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">// s : section</span></span>
<span class="line"><span class="comment">// r: relocation entry</span></span>
<span class="line">for_each section s &#123;</span>
<span class="line">        for_each relocation entry r &#123;</span>
<span class="line">                refptr = s + r.offset;</span>
<span class="line"></span>
<span class="line">                <span class="keyword">if</span> ( r.type == R_X86_64_PC32 ) &#123;</span>
<span class="line">                        refaddr = ADDR ( s ) + r.offset;</span>
<span class="line">                        *refptr = (<span class="keyword">unsigned</span>)( ADDR ( r.symbol ) + r.addend - refaddr );</span>
<span class="line">                &#125;</span>
<span class="line"></span>
<span class="line">                <span class="keyword">if</span> ( r.type == R_X86_64_32 ) &#123;</span>
<span class="line">                        *refptr = (<span class="keyword">unsigned</span>)( ADDR ( r.symbol ) + r.addend );</span>
<span class="line">                &#125;</span>
<span class="line">        &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure></p>
<p><br><br>PC-relative<br>相当于 s[r.offset] = r.symbol - ( s + r.offset ) + r.addend<br>r.symbol: symbol所在的地址（call发生时候的地址）<br>s + r.offset: 函数真正的运行地址<br>r.addend: 运行call时PC的变化 - 1</p>
<p>也就是说0x08 = 62c - 620 + (-4)<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
</pre></td><td class="code"><pre><span class="line"># RELO OBJ</span>
<span class="line">  <span class="number">25</span>:	e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">2</span>a &lt;main+<span class="number">0x23</span>&gt;</span>
<span class="line"></span>
<span class="line"># EXEC OBJ</span>
<span class="line"> <span class="number">61f</span>:	e8 <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">62</span>c &lt;referenced_sum&gt;</span>
<span class="line"> </span>
<span class="line"> <span class="number">000000000000062</span>c &lt;referenced_sum&gt;</span>
</pre></td></tr></table></figure></p>
<p>然后运行时候的call的过程就是刚好相反：</p>
<p>61f + 5(下一个指令的位置，也是为什么addend是-4）+ 8 = 62c</p>
<p><br></p>
<p>Absolute</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
</pre></td><td class="code"><pre><span class="line"><span class="number">4004</span>d9: bf <span class="number">18</span> <span class="number">10</span> <span class="number">60</span> <span class="number">00</span> mov $<span class="number">0x601018</span>, %edi = &amp;<span class="built_in">array</span></span>
</pre></td></tr></table></figure>
<p>array 就直接定位到了0x601018<br>（我这里没重定位绝对引用的就抄书了qwqqwqqwq）</p>
<p><br></p>
<hr>
<h3 id="7-8-Executable-Object-File-可执行"><a href="#7-8-Executable-Object-File-可执行" class="headerlink" title="7.8 Executable Object File - 可执行"></a>7.8 Executable Object File - 可执行</h3><p>格式：<br>| 组成        | 解释 |<br>| ——–   | —–|<br>| ELF header | 只读 |<br>|segment header table|<br>|.init|<br>|.text|<br>|.radata|<br>|.data|读写|<br>|.bss|<br>|.symtab|不加载进内存|<br>|.debug|<br>|.line|<br>|.strtab|<br>|Section header table|</p>
<p>Program header table程序头部表描述了文件里的每一片映射到的连续内存段<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
</pre></td><td class="code"><pre><span class="line"># 部分 Program Headers:</span>
<span class="line"># 静态链接出来的 ld -o prog main.o sum.o， 代码段地址是<span class="number">0x400000</span></span>
<span class="line">  Type           Offset             VirtAddr           PhysAddr</span>
<span class="line">                 FileSiz            MemSiz              Flags  Align</span>
<span class="line">  LOAD           <span class="number">0x0000000000000000</span> <span class="number">0x0000000000400000</span> <span class="number">0x0000000000400000</span></span>
<span class="line">                 <span class="number">0x00000000000001b8</span> <span class="number">0x00000000000001b8</span>  R E    <span class="number">0x200000</span></span>
<span class="line">  LOAD           <span class="number">0x0000000000001000</span> <span class="number">0x0000000000601000</span> <span class="number">0x0000000000601000</span></span>
<span class="line">                 <span class="number">0x0000000000000028</span> <span class="number">0x0000000000000030</span>  RW     <span class="number">0x200000</span></span>
<span class="line"></span>
<span class="line"># 动态（默认）链接出来的 gcc main.c sum.c，代码段地址是相对地址<span class="number">0</span></span>
<span class="line"> Type           Offset             VirtAddr           PhysAddr</span>
<span class="line">                 FileSiz            MemSiz              Flags  Align</span>
<span class="line">      [Requesting program interpreter: /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>]</span>
<span class="line">  LOAD           <span class="number">0x0000000000000000</span> <span class="number">0x0000000000000000</span> <span class="number">0x0000000000000000</span></span>
<span class="line">                 <span class="number">0x00000000000008d0</span> <span class="number">0x00000000000008d0</span>  R E    <span class="number">0x200000</span></span>
<span class="line">  LOAD           <span class="number">0x0000000000000de0</span> <span class="number">0x0000000000200de0</span> <span class="number">0x0000000000200de0</span></span>
<span class="line">                 <span class="number">0x0000000000000260</span> <span class="number">0x0000000000000270</span>  RW     <span class="number">0x200000</span></span>
</pre></td></tr></table></figure></p>
<p><br></p>
<hr>
<h3 id="7-9-Loading-加载可执行文件"><a href="#7-9-Loading-加载可执行文件" class="headerlink" title="7.9 Loading - 加载可执行文件"></a>7.9 Loading - 加载可执行文件</h3><p>输入./prog后</p>
<p>加载Load</p>
<p><img src="https://res.cloudinary.com/dsmx9qa2z/image/upload/v1539953133/Screenshot_from_2018-10-19_16-06-38.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/Aria461863631/MarkdownPic/master/Screenshot%20from%202017-10-17%2021-57-55.png" alt="elelelelel"></p>
<blockquote>
<p>代码段总是从地址0x0400000处开始，它保存编译程序的机器代码</p>
<p>data段在接下来的一个4KB对齐的地址处，保存已初始化的全局C变量和静态变量</p>
<p>bss段记录的是未初始化的全局C变量，事实上它并不占据目标文件的任何空间，只是一个占位符</p>
<p>运行时堆在接下来的第一个4KB对齐的地址处，通过调用malloc库向上增长，用于程序的动态内存管理</p>
<p>共享库段，用于加载共享库、映射共享内存和文件I/O,使用mmap和unmap函数申请和释放新的内存区</p>
<p>用户栈占据进程地址空间的最高部分，并向下增长，用于存放调用过程中的局部变量、函数返回地址、参数</p>
<p>内核代码和数据、物理存储器，它们均被映射到所有进程共享的物理页面，这就为内核提供一个便利的方法来访问内存中任何特定的位置。对于每个进程来说他们均是一样的</p>
<p>最顶层的内核地址空间包括了与进程有关的数据结构，如页表、内核在进程的上下文结构task_struct和mm结构，内核栈</p>
</blockquote>
<p><img src="https://res.cloudinary.com/dsmx9qa2z/image/upload/v1539953652/Screenshot_from_2018-10-19_20-53-40.png" alt="hahahahahallllll"></p>
<p><br></p>
<p><span id="7.10"></span></p>
<hr>
<h3 id="7-10-Shared-Library-共享库"><a href="#7-10-Shared-Library-共享库" class="headerlink" title="7.10 Shared Library - 共享库"></a>7.10 Shared Library - 共享库</h3><p><strong>加载时的链接</strong></p>
<p><strong>优点</strong></p>
<ol>
<li>与共享库连接的可执行文件只包含它需要的函数的引用表，而不是所有的函数代码，只有在程序执行时, 那些需要的函数代码才被拷贝到内存中。</li>
<li>操作系统使用虚拟内存，使得一份共享库驻留在内存中被多个程序使用，也同时节约了内存。</li>
<li>修改后只需要重新编译库，而不用编译使用库的程序</li>
</ol>
<p><strong>缺点</strong></p>
<ul>
<li>运行时要去链接库会花费一定的时间，执行速度相对会慢一些</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
</pre></td><td class="code"><pre><span class="line">gcc -shared -fpic -o libvector.so addvec.c multvec.c #创建</span>
<span class="line">gcc -o prog21 main2.c ./libvector.so                 #链接</span>
</pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Aria461863631/MarkdownPic/master/Screenshot%20from%202017-10-17%2022-05-27.png" alt="qaq"></p>
<p>ppppps<br>没加-fpic会报错…….<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
</pre></td><td class="code"><pre><span class="line">gcc -shared -o nofpicvec.so addvec.c multvec.c</span>
<span class="line"></span>
<span class="line">/usr/bin/ld: /tmp/ccasjaEP.o: relocation R_X86_64_PC32 against symbol `addcnt' can <span class="keyword">not</span> be used when making a shared object; recompile with -fPIC</span>
</pre></td></tr></table></figure></p>
<p><br></p>
<p><span id="7.11"></span></p>
<hr>
<h3 id="7-11-Load-and-Link-Shared-Library-from-Applications-从程序中加载"><a href="#7-11-Load-and-Link-Shared-Library-from-Applications-从程序中加载" class="headerlink" title="7.11 Load and Link Shared Library from Applications - 从程序中加载"></a>7.11 Load and Link Shared Library from Applications - 从程序中加载</h3><p><strong>运行时的链接</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="comment">/* 打开共享库，成功返回指向句柄的指针，失败返回null */</span></span>
<span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">dlopen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">int</span> flag)</span></span>;</span>
<span class="line"></span>
<span class="line"><span class="comment">/* 解析符号，输入是共享库句柄指针和符号名，成功返回符号地址，失败返回null */</span></span>
<span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">dlsym</span><span class="params">(<span class="keyword">void</span> *handle, <span class="keyword">char</span> *symbol)</span></span>;</span>
<span class="line"></span>
<span class="line"><span class="comment">/* 卸载共享库，如果此时没有其他共享库正在使用这个共享库的话 */</span></span>
<span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dlclose</span><span class="params">(<span class="keyword">void</span> *handle)</span></span></span>
<span class="line"><span class="function"></span></span>
<span class="line"><span class="function"><span class="comment">/* 返回上面三个api发生的错误，需要手动调用，没有错误返回null */</span></span></span>
<span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">dlerror</span><span class="params">(<span class="keyword">void</span>)</span></span></span>
</pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
</pre></td><td class="code"><pre><span class="line">gcc -rdynamic -o prog2r dll.c -ldl</span>
</pre></td></tr></table></figure>
<p><br></p>
<p><span id="7.12"></span></p>
<hr>
<h3 id="7-12-Position-Independent-Code-位置无关"><a href="#7-12-Position-Independent-Code-位置无关" class="headerlink" title="7.12 Position Independent Code - 位置无关"></a>7.12 Position Independent Code - 位置无关</h3><p><a href="http://blog.csdn.net/chenji001/article/details/5691690" target="_blank" rel="noopener">编译GNU/Linux共享库, 为什么要用PIC编译?(转)</a><br><a href="https://www.technovelty.org/linux/plt-and-got-the-key-to-code-sharing-and-dynamic-libraries.html" target="_blank" rel="noopener">PLT and GOT - the key to code sharing and dynamic libraries</a></p>
<p>实现多进程共享内存中唯一一个的库代码的方法</p>
<ul>
<li>如果固定每个库分配到的内存片<ol>
<li>不使用的库也会被分配空间</li>
<li>必须保证每个库更新之后片也不会重叠，就会变得很难管理</li>
</ol>
</li>
</ul>
<p>可以在任意位置加载而无需链接器进行修改，这样的代码被称作位置无关代码（PIC）</p>
<p><br></p>
<p><strong>运行时数据段和代码段的偏移量不变</strong></p>
<p>读写数据节总是放在到这个库代码节的一个已知的偏移位置<br>即 我希望对象的地址 = 当前地址 + 已知固定的偏移。</p>
<p>为了利用这一特点，编译器在数据段的开头创建了一个全局偏移表（GOT）。在GOT中，目标模块所引用的每个全局数据对象都对应一个表项。编译器同时为GOT中的每个表项生成了一个重定位记录。在加载时，动态链接器重定位GOT中的每个表项，使其包含正确的绝对地址。每个包含全局数据引用的目标模块都有其自己的GOT。</p>
<h4 id="7-12-1-数据"><a href="#7-12-1-数据" class="headerlink" title="7.12.1 数据"></a>7.12.1 数据</h4><p><img src="https://raw.githubusercontent.com/Aria461863631/MarkdownPic/master/Screenshot%20from%202017-10-17%2022-24-45.png" alt="此处输入图片的描述"><br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment"># objdump -d libvec.so</span></span>
<span class="line">000000000000064a &lt;addvec&gt;:</span>
<span class="line"> 65d:	48 8b 05 84 09 20 00 	mov    0x200984(%rip),%rax        <span class="comment"># 200fe8 &lt;addcnt@@Base-0x3c&gt;</span></span>
<span class="line"> 664:	8b 00                	mov    (%rax),%eax</span>
<span class="line"> 666:	8d 50 01             	lea    0x1(%rax),%edx</span>
</pre></td></tr></table></figure></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment"># readelf --relocs libvector.so </span></span>
<span class="line">Relocation section <span class="string">'.rela.dyn'</span> at offset 0x478 contains 9 entries:</span>
<span class="line">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span>
<span class="line">000000200fe8  000900000006 R_X86_64_GLOB_DAT 0000000000201024 addcnt + 0</span>
</pre></td></tr></table></figure>
<p>这里是%rip + 0x200984 = 0x200fe8 （ GOT 表里的位置 ）<br>这样，加载时候的重定位只需要找到addcnt的真实地址，然后放到GOT表里就行了，不需要修改代码的任何值</p>
<p><br></p>
<h4 id="7-12-2-函数"><a href="#7-12-2-函数" class="headerlink" title="7.12.2 函数"></a>7.12.2 函数</h4><p>延迟绑定 lazy binding</p>
<p>在这里使用的间接性被称为一个过程连接表或PLT。代码不会直接调用一个外部函数，只会通过一个PLT存根。</p>
<p><img src="https://raw.githubusercontent.com/Aria461863631/MarkdownPic/master/Screenshot%20from%202017-10-17%2022-25-42.png" alt="此处输入图片的描述"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta"># objdump -d prog21</span></span>
<span class="line"><span class="number">000000000000075</span>a &lt;main&gt;:</span>
<span class="line"><span class="number">778</span>:	e8 c3 fe ff ff       	callq  <span class="number">640</span> &lt;addvec@plt&gt;</span>
</pre></td></tr></table></figure>
<ul>
<li>首先main函数跳到plt表里addvec的位置0x640<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta"># objdump -D prog21</span></span>
<span class="line">Disc of section .plt:</span>
<span class="line"></span>
<span class="line"><span class="number">0000000000000640</span> &lt;addvec@plt&gt;:</span>
<span class="line"> <span class="number">640</span>:	ff <span class="number">25</span> da <span class="number">09</span> <span class="number">20</span> <span class="number">00</span>    	jmpq   *<span class="number">0x2009da</span>(%rip)        # <span class="number">201020</span> &lt;addvec&gt;</span>
<span class="line"> <span class="number">646</span>:	<span class="number">68</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	pushq  $<span class="number">0x1</span></span>
<span class="line"> <span class="number">64b</span>:	e9 d0 ff ff ff       	jmpq   <span class="number">620</span> &lt;.plt&gt;</span>
</pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta"># readelf --relocs prog21</span></span>
<span class="line">Relocation section '.rela.plt' at offset 0x5d8 contains 2 entries:</span>
<span class="line">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span>
<span class="line"><span class="number">000000201020</span>  <span class="number">000400000007</span> R_X86_64_JUMP_SLO <span class="number">0000000000000000</span> addvec + <span class="number">0</span></span>
</pre></td></tr></table></figure>
<ul>
<li>plt跳到addvec重定位的位置0x201020</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
</pre></td><td class="code"><pre><span class="line">Disc of section .got.plt:</span>
<span class="line"></span>
<span class="line"><span class="number">0000000000201000</span> &lt;_GLOBAL_OFFSET_TABLE_&gt;:</span>
<span class="line">  <span class="number">201000</span>:	e0 <span class="number">0</span>d                	loopne <span class="number">20100f</span> &lt;_GLOBAL_OFFSET_TABLE_+<span class="number">0xf</span>&gt;</span>
<span class="line">  <span class="number">201002</span>:	<span class="number">20</span> <span class="number">00</span>                	<span class="keyword">and</span>    %al,(%rax)</span>
<span class="line">	...</span>
<span class="line">  <span class="number">201018</span>:	<span class="number">36</span> <span class="number">06</span>                	ss (bad) </span>
<span class="line">  <span class="number">20101</span>a:	<span class="number">00</span> <span class="number">00</span>                	add    %al,(%rax)</span>
<span class="line">  <span class="number">20101</span>c:	<span class="number">00</span> <span class="number">00</span>                	add    %al,(%rax)</span>
<span class="line">  <span class="number">20101</span>e:	<span class="number">00</span> <span class="number">00</span>                	add    %al,(%rax)</span>
<span class="line">  <span class="number">201020</span>:	<span class="number">46</span> <span class="number">06</span>                	rex.RX (bad) </span>
<span class="line">  <span class="number">201022</span>:	<span class="number">00</span> <span class="number">00</span>                	add    %al,(%rax)</span>
<span class="line">  <span class="number">201024</span>:	<span class="number">00</span> <span class="number">00</span>                	add    %al,(%rax)</span>
<span class="line">	...</span>
</pre></td></tr></table></figure>
<ul>
<li>初始状态下，可以看到上面0x201020的位置是…..emmmm空的……</li>
<li><p>所以返回去运行下一条指令 pushq 1， 然后跳去.plt</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
</pre></td><td class="code"><pre><span class="line"><span class="number">0000000000000620</span> &lt;.plt&gt;:</span>
<span class="line"> <span class="number">620</span>:	ff <span class="number">35</span> e2 <span class="number">09</span> <span class="number">20</span> <span class="number">00</span>    	pushq  <span class="number">0x2009e2</span>(%rip)        # <span class="number">201008</span> &lt;_GLOBAL_OFFSET_TABLE_+<span class="number">0x8</span>&gt;</span>
<span class="line"> <span class="number">626</span>:	ff <span class="number">25</span> e4 <span class="number">09</span> <span class="number">20</span> <span class="number">00</span>    	jmpq   *<span class="number">0x2009e4</span>(%rip)        # <span class="number">201010</span> &lt;_GLOBAL_OFFSET_TABLE_+<span class="number">0x10</span>&gt;</span>
<span class="line"> <span class="number">62</span>c:	<span class="number">0f</span> <span class="number">1f</span> <span class="number">40</span> <span class="number">00</span>          	nopl   <span class="number">0x0</span>(%rax)</span>
</pre></td></tr></table></figure>
</li>
<li><p>plt[0]就把GOT[1]（不知道是什么参数）push进栈</p>
</li>
<li>然后往下召唤GOT[2]里的动态链接器，确定addvec运行时的真正地址，再把地址赋给0x201020</li>
<li>然后以后再找的时候就可以从GOT里取了</li>
</ul>
<p>这就是延迟绑定（lazy binding）<br>推迟解析实际用到的函数，避免不需要的重定位。</p>
<p><br></p>
<hr>
<h3 id="7-13-Library-Interpositioning-库打桩"><a href="#7-13-Library-Interpositioning-库打桩" class="headerlink" title="7.13 Library Interpositioning - 库打桩"></a>7.13 Library Interpositioning - 库打桩</h3><p>用自己的代码取代库<br>编译，链接，运行三种</p>
<p>基本思想：给定一个目标函数，创建一个原型与目标函数完全一样的包装函数，使用某种特殊的打桩机制，欺骗系统调用包装函数而不是打桩函数。</p>
<p><br></p>
<h4 id="7-13-1-编译时打桩-Compile-Time-Interpositioning"><a href="#7-13-1-编译时打桩-Compile-Time-Interpositioning" class="headerlink" title="7.13.1 编译时打桩 (Compile-Time Interpositioning)"></a>7.13.1 编译时打桩 (Compile-Time Interpositioning)</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">// Example program int.c</span></span>
<span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc.h&gt;</span></span></span>
<span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span>
<span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span></span></span>
<span class="line"><span class="function"></span></span>
<span class="line"><span class="function"></span>&#123;</span>
<span class="line">        <span class="keyword">int</span> *p = <span class="built_in">malloc</span> ( <span class="number">32</span> );</span>
<span class="line">        <span class="built_in">free</span> ( p );</span>
<span class="line">        <span class="keyword">return</span> ( <span class="number">0</span> );</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">//Local malloc.h file</span></span>
<span class="line"><span class="meta">#<span class="meta-keyword">define</span> malloc(size) mymalloc(size)</span></span>
<span class="line"><span class="meta">#<span class="meta-keyword">define</span> free(ptr) myfree(ptr)</span></span>
<span class="line"></span>
<span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mymalloc</span><span class="params">(<span class="keyword">size_t</span> size)</span></span>;</span>
<span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myfree</span><span class="params">(<span class="keyword">void</span> *ptr)</span></span>;</span>
</pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">// wrapper functions in mymalloc.c</span></span>
<span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> COMPILETIME <span class="comment">//编译时传入参数-DCOMPILETIME可编译</span></span></span>
<span class="line"></span>
<span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc.h&gt;</span></span></span>
<span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mymalloc</span> <span class="params">( <span class="keyword">size_t</span> size )</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">        <span class="keyword">void</span> *ptr = <span class="built_in">malloc</span> ( size );</span>
<span class="line">        <span class="built_in">printf</span> ( <span class="string">"malloc(%d)=%p\n"</span>, (<span class="keyword">int</span>)size, ptr );</span>
<span class="line">        <span class="keyword">return</span> ptr;</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myfree</span> <span class="params">( <span class="keyword">void</span> *ptr )</span></span></span>
<span class="line"><span class="function"></span></span>
<span class="line"><span class="function"></span>&#123;</span>
<span class="line">        <span class="built_in">free</span> ( ptr );</span>
<span class="line">        <span class="built_in">printf</span> ( <span class="string">"free(%p)\n"</span>, ptr );</span>
<span class="line">&#125;</span>
<span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span>
</pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
</pre></td><td class="code"><pre><span class="line"># 编译和链接命令</span>
<span class="line">gcc -DCOMPILETIME -c mymalloc.c</span>
<span class="line">gcc -I. -o intc <span class="keyword">int</span>.c mymalloc.o</span>
</pre></td></tr></table></figure>
<p>-I.参数告诉C预处理器在搜索系统目录之前，现在当前目录中查找malloc.h，通过malloc.h文件中</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> malloc(size) mymalloc(size)</span></span>
<span class="line"><span class="meta">#<span class="meta-keyword">define</span> free(ptr) myfree(ptr)</span></span>
</pre></td></tr></table></figure>
<p>指示预处理器用对相应包装函数的调用替换掉对目标函数的调用。</p>
<p><br></p>
<h4 id="7-13-2-链接时打桩-Link-Time-Interpositioning"><a href="#7-13-2-链接时打桩-Link-Time-Interpositioning" class="headerlink" title="7.13.2 链接时打桩(Link-Time Interpositioning)"></a>7.13.2 链接时打桩(Link-Time Interpositioning)</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> LINKTIME</span></span>
<span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="keyword">void</span> *__real_malloc ( <span class="keyword">size_t</span> size );</span>
<span class="line"><span class="keyword">void</span> __real_free ( <span class="keyword">void</span> *prt );</span>
<span class="line"></span>
<span class="line"><span class="keyword">void</span> *__wrap_malloc ( <span class="keyword">size_t</span> size ) &#123;</span>
<span class="line">        <span class="keyword">void</span> *ptr = __real_malloc ( size );</span>
<span class="line">        <span class="built_in">printf</span> ( <span class="string">"malloc(%d)=%p\n"</span>, (<span class="keyword">int</span>)size, ptr );</span>
<span class="line">        <span class="keyword">return</span> ptr;</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="keyword">void</span> __wrap_free ( <span class="keyword">void</span> *ptr ) &#123;</span>
<span class="line">        __real_free ( ptr );</span>
<span class="line">        <span class="built_in">printf</span> ( <span class="string">"free(%p)\n"</span>, ptr );</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span>
</pre></td></tr></table></figure>
<p>Linux 静态链接器支持用 <code>--wrap f</code> 标志进行链接时打桩。这个标志告诉链接器将 <code>f</code> 解析成 <code>__wrap_f</code>，讲 <code>__real_</code> 解析成 <code>f</code> 。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
</pre></td><td class="code"><pre><span class="line">gcc -DLINKTIME -c mymalloc.c</span>
<span class="line">gcc -c <span class="keyword">int</span>.c</span>
<span class="line">gcc -Wl,--wrap,<span class="built_in">malloc</span> -Wl,--wrap,<span class="built_in">free</span> -o intl <span class="keyword">int</span>.o mymalloc.o</span>
</pre></td></tr></table></figure>
<p><code>-Wl,option</code>标志把 <code>option</code>传递给链接器，并把 <code>option</code> 中的 <code>，</code> 替换成空格<br><code>-Wl,--wrap,malloc</code> 把 <code>--wrap malloc</code>传递给链接器<br><code>-Wl,--wrap,free</code> 把 <code>--wrap free</code>传递给链接器</p>
<p><br></p>
<h4 id="7-13-3-运行时打桩-Run-Time-Interpositioning"><a href="#7-13-3-运行时打桩-Run-Time-Interpositioning" class="headerlink" title="7.13.3 运行时打桩 (Run-Time Interpositioning)"></a>7.13.3 运行时打桩 (Run-Time Interpositioning)</h4><p>编译时打桩需要能够访问程序的源代码<br>链接时打桩需要能够访问程序的可重定位文件<br>运行时打桩只需要能够访问可执行目标</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
<span class="line">38</span>
<span class="line">39</span>
<span class="line">40</span>
<span class="line">41</span>
<span class="line">42</span>
<span class="line">43</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> RUNTIME</span></span>
<span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span>
<span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span>
<span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span>
<span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="comment">// malloc wrapper function</span></span>
<span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span> <span class="params">( <span class="keyword">size_t</span> size )</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">        <span class="keyword">void</span> *( *mallocp ) ( <span class="keyword">size_t</span> size );</span>
<span class="line"></span>
<span class="line">        <span class="comment">// get address of libc malloc</span></span>
<span class="line">        mallocp = dlsym ( RTLD_NEXT, <span class="string">"malloc"</span> );</span>
<span class="line"></span>
<span class="line">        <span class="keyword">if</span> ( ( error = dlerror () ) != <span class="literal">NULL</span> ) &#123;</span>
<span class="line">                <span class="built_in">fputs</span> ( error, <span class="built_in">stderr</span> );</span>
<span class="line">                <span class="built_in">exit</span> ( <span class="number">1</span> );</span>
<span class="line">        &#125;</span>
<span class="line"></span>
<span class="line">        <span class="keyword">char</span> *ptr = mallocp ( size );</span>
<span class="line">        <span class="built_in">printf</span> ( <span class="string">"malloc %p size %p\n"</span>, ptr, (<span class="keyword">int</span>)size );</span>
<span class="line">        <span class="keyword">return</span> ptr;</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="comment">// free wrapper function</span></span>
<span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span> <span class="params">( <span class="keyword">void</span> *ptr )</span> </span>&#123;</span>
<span class="line">        <span class="keyword">void</span> ( *freep ) ( <span class="keyword">void</span> *ptr );</span>
<span class="line">        <span class="keyword">char</span> *error;</span>
<span class="line"></span>
<span class="line">        <span class="keyword">if</span> ( !ptr )</span>
<span class="line">                <span class="keyword">return</span>;</span>
<span class="line"></span>
<span class="line">        <span class="comment">// get address of libc free</span></span>
<span class="line">        freep = dlsym ( RTLD_NEXT, <span class="string">"free"</span> );</span>
<span class="line">        <span class="keyword">if</span> ( ( error = dlerror () ) != <span class="literal">NULL</span> ) &#123;</span>
<span class="line">                <span class="built_in">fputs</span> ( error, <span class="built_in">stderr</span> );</span>
<span class="line">                <span class="built_in">exit</span> ( <span class="number">1</span> );</span>
<span class="line">        &#125;</span>
<span class="line"></span>
<span class="line">        freep ( ptr );</span>
<span class="line">        <span class="built_in">printf</span> ( <span class="string">"free %p\n"</span>, ptr );</span>
<span class="line">&#125;</span>
<span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span>
</pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
</pre></td><td class="code"><pre><span class="line">gcc -DRUNTIME -shared -fpic -o mymalloc.so mymalloc.c -ldl</span>
<span class="line">gcc -o intr <span class="keyword">int</span>.c</span>
<span class="line">LD_PRELOAD=<span class="string">"./mymalloc.so"</span> ./intr</span>
</pre></td></tr></table></figure>
<p>如果 <code>LD_PRELOAD</code> 环境变量被设置为一个共享库路径名的列表（以空格键或分号分隔），那么当加载和执行一个程序，需要解析未定义的引用时，动态链接器（LD_LINUX.SO）会先搜索LD_PRELAOD库，然后才搜索其他库。 </p>
<p>​<br>​    </p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/CSAPP/" rel="tag"><i class="fa fa-tag"></i> CSAPP</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/08/30/CSAPP/attack/" rel="next" title="[CS:APP-ch3] Attack Lab">
                <i class="fa fa-chevron-left"></i> [CS:APP-ch3] Attack Lab
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/12/10/ACM/kuangbin-4/" rel="prev" title="kuangbin专题四 最短路">
                kuangbin专题四 最短路 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="Aria" />
            
              <p class="site-author-name" itemprop="name">Aria</p>
              <p class="site-description motion-element" itemprop="description">This guy is so lazy that he left nothing</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://goushi.me/" title="ダーリンのblog" target="_blank">ダーリンのblog</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Linker"><span class="nav-number">1.</span> <span class="nav-text">Linker</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SUMMARY"><span class="nav-number">1.0.1.</span> <span class="nav-text">SUMMARY</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-链接器的任务"><span class="nav-number">1.0.1.1.</span> <span class="nav-text">1.链接器的任务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-链接方式"><span class="nav-number">1.0.1.2.</span> <span class="nav-text">2.链接方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-PIC"><span class="nav-number">1.0.1.3.</span> <span class="nav-text">3.PIC</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-Complier-Driver-编译器驱动"><span class="nav-number">1.0.2.</span> <span class="nav-text">7.1 Complier Driver - 编译器驱动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-Static-Library-静态链接"><span class="nav-number">1.0.3.</span> <span class="nav-text">7.2 Static Library - 静态链接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-Object-Files-目标文件"><span class="nav-number">1.0.4.</span> <span class="nav-text">7.3 Object Files - 目标文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-Relocatable-Object-Files-可重定位"><span class="nav-number">1.0.5.</span> <span class="nav-text">7.4 Relocatable Object Files - 可重定位</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-Symbol-and-Symbol-Tables-符号和符号表"><span class="nav-number">1.0.6.</span> <span class="nav-text">7.5 Symbol and Symbol Tables - 符号和符号表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#symbol的种类有3个"><span class="nav-number">1.0.6.1.</span> <span class="nav-text">symbol的种类有3个</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#每个symbol的结构"><span class="nav-number">1.0.6.2.</span> <span class="nav-text">每个symbol的结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-6-Symbol-Resolution-符号解析"><span class="nav-number">1.0.7.</span> <span class="nav-text">7.6 Symbol Resolution - 符号解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-1-Resolve-Multiply-Defined-Global-Symbols"><span class="nav-number">1.0.7.1.</span> <span class="nav-text">7.6.1 Resolve Multiply Defined Global Symbols</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-2-Linking-with-Static-Libraries-链接静态库"><span class="nav-number">1.0.7.2.</span> <span class="nav-text">7.6.2 Linking with Static Libraries - 链接静态库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-3-Use-static-library-resolve-reference"><span class="nav-number">1.0.7.3.</span> <span class="nav-text">7.6.3 Use static library resolve reference</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-7-Relocation-重定位"><span class="nav-number">1.0.8.</span> <span class="nav-text">7.7 Relocation - 重定位</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-7-1-Relocation-Entry-重定位条目"><span class="nav-number">1.0.8.1.</span> <span class="nav-text">7.7.1 Relocation Entry - 重定位条目</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-7-2-Relocating-Symbol-References"><span class="nav-number">1.0.8.2.</span> <span class="nav-text">7.7.2 Relocating Symbol References</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-8-Executable-Object-File-可执行"><span class="nav-number">1.0.9.</span> <span class="nav-text">7.8 Executable Object File - 可执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-9-Loading-加载可执行文件"><span class="nav-number">1.0.10.</span> <span class="nav-text">7.9 Loading - 加载可执行文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-10-Shared-Library-共享库"><span class="nav-number">1.0.11.</span> <span class="nav-text">7.10 Shared Library - 共享库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-11-Load-and-Link-Shared-Library-from-Applications-从程序中加载"><span class="nav-number">1.0.12.</span> <span class="nav-text">7.11 Load and Link Shared Library from Applications - 从程序中加载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-12-Position-Independent-Code-位置无关"><span class="nav-number">1.0.13.</span> <span class="nav-text">7.12 Position Independent Code - 位置无关</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-12-1-数据"><span class="nav-number">1.0.13.1.</span> <span class="nav-text">7.12.1 数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-12-2-函数"><span class="nav-number">1.0.13.2.</span> <span class="nav-text">7.12.2 函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-13-Library-Interpositioning-库打桩"><span class="nav-number">1.0.14.</span> <span class="nav-text">7.13 Library Interpositioning - 库打桩</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-13-1-编译时打桩-Compile-Time-Interpositioning"><span class="nav-number">1.0.14.1.</span> <span class="nav-text">7.13.1 编译时打桩 (Compile-Time Interpositioning)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-13-2-链接时打桩-Link-Time-Interpositioning"><span class="nav-number">1.0.14.2.</span> <span class="nav-text">7.13.2 链接时打桩(Link-Time Interpositioning)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-13-3-运行时打桩-Run-Time-Interpositioning"><span class="nav-number">1.0.14.3.</span> <span class="nav-text">7.13.3 运行时打桩 (Run-Time Interpositioning)</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>

    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Aria</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>





        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

   
  <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  <script type="text/javascript">
    $(function() {
    hljs.initHighlighting();
      $('pre code').each(function() {
      var lines = $(this).text().split('\n').length - 1;
      var $numbering = $('<ul/>').addClass('pre-numbering');
      $(this)
        .addClass('has-numbering')
        .parent()
        .append($numbering);
      for (i = 1; i <= lines; i++) {
        $numbering.append($('<li/>'));
      }
    });
  });
  </script>

  <style>
  pre {
    position: relative;
    padding: 0;
  }

  code.has-numbering {
    margin-left: 2.5rem;
  }

  code.has-numbering::-webkit-scrollbar {
    display: none;
  }

  .pre-numbering {
    margin: 0;
    position: absolute;
    top: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    height: 100%;
  }

  .pre-numbering li {
    list-style-type: decimal-leading-zero !important;
  }

  @media (max-width: 760px) {
    .post-body pre {
      padding: 0px;
    }

    .post-body .pre-numbering {
      display: none;
    }

    code.has-numbering {
      margin: 0;
    }
  }

  </style>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'IymLYXEiDNakEwJDxlM131NL-gzGzoHsz',
        appKey: 'yLV88RGE7RiUo5ybkLy6PqP7',
        placeholder: '(ゝ∀･)ciao~',
        avatar:'/hahah.jpg',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
  


  

  

</body>
</html>


